package edu.ncsu.csc.itrust.action;

import java.util.List;
import edu.ncsu.csc.itrust.beans.OfficeVisitBean;
import edu.ncsu.csc.itrust.beans.ReferralBean;
import edu.ncsu.csc.itrust.beans.VerboseReferralBean;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.dao.mysql.OfficeVisitDAO;
import edu.ncsu.csc.itrust.dao.mysql.ReferralDAO;
import edu.ncsu.csc.itrust.enums.SortDirection;
import edu.ncsu.csc.itrust.exception.DBException;
import edu.ncsu.csc.itrust.exception.ITrustException;

/**
 * This class is an action class that sits in between the JSP and the DAO The methods help facilitate
 * functionality for the viewPatientReferrals.jsp
 * 
 */
public class ViewPatientReferralsAction {

	private ReferralDAO referralDAO;
	private OfficeVisitDAO ovDAO;
	private long patientID;

	public ViewPatientReferralsAction(DAOFactory factory, long patientID) throws ITrustException {
		this.referralDAO = factory.getReferralDAO();
		this.ovDAO = factory.getOfficeVisitDAO();
		this.patientID = patientID;
	}

	/**
	 * Get all referrals for a patient sorted by the given field and in the given direction.
	 * 
	 * @param field
	 *            The name of the pseudo-field to sort by.
	 * @param dir
	 *            The direction of the sort.
	 * @return
	 * @throws DBException
	 */
	public List<VerboseReferralBean> getReferrals(String field, SortDirection dir) throws DBException {
		return referralDAO.getPatientQuery(patientID).query(field, dir);
	}

	/**
	 * This method returns the number of messages for a given patient that have not been read.
	 * 
	 * @return
	 * @throws DBException
	 */
	public int getReferralsForPatientUnread() throws DBException {
		return referralDAO.getReferralsForPatientUnread(patientID).size();
	}

	/**
	 * This method gets a referral by its id
	 * 
	 * @param id
	 * @return a referral bean
	 * @throws DBException
	 */
	public ReferralBean getReferralByID(int id) throws DBException {
		return referralDAO.getReferral(id);
	}

	/**
	 * This method updates the referral in the DAO
	 * 
	 * @param bean
	 * @return a boolean expression used for testability
	 * @throws DBException
	 */
	public boolean updateReferral(ReferralBean bean) throws DBException {
		referralDAO.editReferral(bean);
		return true;
	}
	
	/**
	 * This method updates the referral in the DAO
	 * 
	 * @param bean
	 * @return a boolean expression used for testability
	 * @throws DBException
	 */
	public boolean setReferralMessage(long messageID, long referralID) throws DBException {
		referralDAO.setReferralMessage(messageID, referralID);
		return true;
	}

	/**
	 * This method returns an office visit bean given its id. The purpose is to use the bean in the related
	 * JSP to get the office visit date.
	 * 
	 * @param id
	 * @return an office visit bean
	 * @throws DBException
	 */
	public OfficeVisitBean getOVDate(long id) throws DBException {
		return ovDAO.getOfficeVisit(id);
	}

	/**
	 * Test method for {@link edu.ncsu.csc.itrust.action.ViewPatientReferralsAction#getReferralByID(int)}.
	 * @throws DBException 
	 */
	public void testGetReferralByID() throws DBException {
		ReferralBean b = action.getReferralByID(1);
		
		assertEquals(1, b.getId());
		assertEquals(1, b.getPriority());
		assertEquals(2L, b.getPatientID());
		assertEquals(9000000000L, b.getSenderID());
		assertEquals(9000000003L, b.getReceiverID());
		assertEquals("Gandalf will make sure that the virus does not get past your immune system", b.getReferralDetails());
		assertEquals(955L, b.getOvid());
		assertFalse(b.isViewedByHCP());
		assertFalse(b.isViewedByPatient());
	
	}

	/**
	 * Test method for {@link edu.ncsu.csc.itrust.action.ViewPatientReferralsAction#updateReferral(edu.ncsu.csc.itrust.beans.ReferralBean)}.
	 * @throws DBException 
	 */
	public void testUpdateReferral() throws DBException {
		ReferralBean b = action.getReferralByID(1);
		assertEquals(1, b.getId());
		assertEquals(1, b.getPriority());
		assertEquals(2L, b.getPatientID());
		assertEquals(9000000000L, b.getSenderID());
		assertEquals(9000000003L, b.getReceiverID());
		assertEquals("Gandalf will make sure that the virus does not get past your immune system", b.getReferralDetails());
		assertEquals(955L, b.getOvid());
		assertFalse(b.isViewedByHCP());
		assertFalse(b.isViewedByPatient());
		
		b.setPriority(2);
		b.setViewedByHCP(true);
		b.setViewedByPatient(true);
		
		action.updateReferral(b);
		
		b = action.getReferralByID(1);
		
		assertEquals(1, b.getId());
		assertEquals(2, b.getPriority());
		assertEquals(2L, b.getPatientID());
		assertEquals(9000000000L, b.getSenderID());
		assertEquals(9000000003L, b.getReceiverID());
		assertEquals("Gandalf will make sure that the virus does not get past your immune system", b.getReferralDetails());
		assertEquals(955L, b.getOvid());
		assertTrue(b.isViewedByHCP());
		assertTrue(b.isViewedByPatient());
		
	}

	/**
	 * Test method for {@link edu.ncsu.csc.itrust.action.ViewPatientReferralsAction#getOVDate(long)}.
	 * @throws DBException 
	 */
	public void testGetOVDate() throws DBException {
		OfficeVisitBean b = action.getOVDate(955L);
		
		assertEquals(955, b.getID());
		assertEquals(9000000000L, b.getHcpID());
		assertEquals(2L, b.getPatientID());
		assertEquals("Yet another office visit.", b.getNotes());
		assertEquals("06/10/2007", b.getVisitDateStr());
		
		
	}

}
