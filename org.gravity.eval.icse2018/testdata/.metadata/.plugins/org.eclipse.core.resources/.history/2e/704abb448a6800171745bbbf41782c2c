package edu.ncsu.csc.itrust.unit.action;

import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.Calendar;
import java.util.Date;
import java.util.List;

import edu.ncsu.csc.itrust.action.EditApptAction;
import edu.ncsu.csc.itrust.action.ViewMyApptsAction;
import edu.ncsu.csc.itrust.beans.ApptBean;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.exception.DBException;
import edu.ncsu.csc.itrust.exception.FormValidationException;
import edu.ncsu.csc.itrust.exception.ITrustException;
import junit.framework.TestCase;

public class EditApptActionTest extends TestCase {
	private EditApptAction editAction;
	private EditApptAction evilAction;
	private ViewMyApptsAction viewAction;
	private DAOFactory factory;
	private DAOFactory evilFactory;
	private long hcpId = 9000000000L;
	
	/**
	 * testGetName
	 * @throws ITrustException
	 */
	public void testGetName() throws ITrustException {
		assertEquals("Kelly Doctor", editAction.getName(hcpId));
		assertEquals("Bad Horse", editAction.getName(42));
	}
	
	/**
	 * testEditAppt
	 * @throws DBException
	 * @throws SQLException
	 * @throws FormValidationException
	 */
	public void testEditAppt() throws DBException, SQLException, FormValidationException {
		List<ApptBean> appts = viewAction.getAllMyAppointments();
		ApptBean orig = appts.get(0);
		ApptBean b = new ApptBean();
		b.setApptID(orig.getApptID());
		b.setDate(orig.getDate());
		b.setApptType(orig.getApptType());
		b.setHcp(orig.getHcp());
		b.setPatient(orig.getPatient());
		b.setComment("New comment!");
		
		String s = editAction.editAppt(b, true);
		assertTrue(s.contains("The scheduled date of this appointment"));
		assertTrue(s.contains("has already passed"));
		
		Date d = new Date();
		boolean changed = false;
		for (ApptBean aBean : appts) {
			b = new ApptBean();
			b.setApptID(aBean.getApptID());
			b.setDate(aBean.getDate());
			b.setApptType(aBean.getApptType());
			b.setHcp(aBean.getHcp());
			b.setPatient(aBean.getPatient());
			b.setComment("New comment!");
			d.setTime(aBean.getDate().getTime());
			if (d.after(new Date())) {
				s = editAction.editAppt(b, true);
				assertEquals("Success: Appointment changed", s);
				changed = true;
				break;
			}
		}
		
		if (!changed)
			fail();
	}
	
	/**
	 * testEditApptConflict
	 * @throws Exception
	 */
	public void testEditApptConflict() throws Exception {
		
		Calendar c = Calendar.getInstance();
		c.add(Calendar.DATE, 12);
		c.set(Calendar.HOUR, 9);
		c.set(Calendar.AM_PM, Calendar.AM);
		c.set(Calendar.MINUTE, 45);
		
		List<ApptBean> appts = viewAction.getMyAppointments();
		ApptBean orig = appts.get(0);
		ApptBean b = new ApptBean();
		b.setApptID(orig.getApptID());
		b.setDate(new Timestamp(c.getTimeInMillis()));
		b.setApptType(orig.getApptType());
		b.setHcp(orig.getHcp());
		b.setPatient(orig.getPatient());
		
		String s = editAction.editAppt(b, false);
		assertTrue(s.contains("conflict"));
		
	}
}
