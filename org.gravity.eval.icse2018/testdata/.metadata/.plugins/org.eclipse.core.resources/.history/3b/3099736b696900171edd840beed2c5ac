package edu.ncsu.csc.itrust.unit.testutils;

import java.io.BufferedReader;
import java.io.FileReader;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.List;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;
import org.apache.commons.dbcp.BasicDataSource;
import org.w3c.dom.Document;
import org.xml.sax.InputSource;

import edu.ncsu.csc.itrust.action.AddRemoteMonitoringDataAction;
import edu.ncsu.csc.itrust.action.ViewHealthRecordsHistoryAction;
import edu.ncsu.csc.itrust.action.ViewMyMessagesAction;
import edu.ncsu.csc.itrust.beans.HealthRecord;
import edu.ncsu.csc.itrust.beans.OfficeVisitBean;
import edu.ncsu.csc.itrust.beans.RemoteMonitoringDataBean;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.dao.IConnectionDriver;
import edu.ncsu.csc.itrust.dao.mysql.HealthRecordsDAO;
import edu.ncsu.csc.itrust.dao.mysql.OfficeVisitDAO;
import edu.ncsu.csc.itrust.exception.FormValidationException;
import edu.ncsu.csc.itrust.exception.ITrustException;
import edu.ncsu.csc.itrust.unit.datagenerators.TestDataGenerator;

/**
 * This class pulls the JDBC driver information from Tomcat's context.xml file in
 * WebRoot/META-INF/context.xml. This is done only for convenience - so that you only have to pull your JDBC
 * info from one place (context.xml)<br />
 * <br />
 * The tangled mess you see here is SAX, the XML-parser and XPath, an XML querying language. Note that this
 * class is only ever constructed once since DAOFactory only constructs up to 2 instances of itself.<br />
 * <br />
 * Also, you'll notice that we're using a "BasicDataSource" to obtain connections instead of the usual
 * DriverManager. That's because we're using Tomcat's built-in database pooling mechanism. It's purely for
 * performance in this case.
 */
public class TestDAOFactory extends DAOFactory implements IConnectionDriver {

	private static DAOFactory testInstance;

	public static DAOFactory getTestInstance() {
		if (testInstance == null)
			testInstance = new TestDAOFactory();
		return testInstance;
	}

	private BasicDataSource dataSource;

	private TestDAOFactory() {
		try {
			Document document = parseXML(new BufferedReader(new FileReader("WebRoot/META-INF/context.xml")));
			dataSource = new BasicDataSource();
			dataSource.setDriverClassName(getAttribute(document, "@driverClassName"));
			dataSource.setUsername(getAttribute(document, "@username"));
			dataSource.setPassword(getAttribute(document, "@password"));
			dataSource.setUrl(getAttribute(document, "@url"));
			dataSource.setMaxActive(3); // only allow three connections open at a time
			dataSource.setMaxWait(250); // wait 250ms until throwing an exception
			dataSource.setPoolPreparedStatements(true);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	private String getAttribute(Document document, String attribute) throws XPathExpressionException {
		return (String) XPathFactory.newInstance().newXPath().compile("/Context/Resource/" + attribute)
				.evaluate(document.getDocumentElement(), XPathConstants.STRING);
	}

	private Document parseXML(BufferedReader reader) throws Exception {
		DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
		factory.setValidating(false);
		DocumentBuilder builder = factory.newDocumentBuilder();
		return builder.parse(new InputSource(reader));
	}

	@Override
	public Connection getConnection() throws SQLException {
		return dataSource.getConnection();
	}

	@Override
	protected void setUp() throws Exception {
		super.setUp();
		
		TestDataGenerator gen = new TestDataGenerator();
		gen.clearAllTables();
		gen.standardData();
	
		this.factory = TestDAOFactory.getTestInstance();
		this.evilFactory = EvilDAOFactory.getEvilInstance();
		this.action = new ViewMyMessagesAction(this.factory, this.mId);
		this.action2 = new ViewMyMessagesAction(this.factory, this.hcpId);
		this.evilAction = new ViewMyMessagesAction(this.evilFactory, this.mId);
	}

	/**
	 * testAddRemoteMonitoringDataUAP
	 * @throws Exception
	 */
	public void testAddRemoteMonitoringDataUAP() throws Exception {
		gen.uap1();
		gen.remoteMonitoringUAP();
		AddRemoteMonitoringDataAction actionUAP = new AddRemoteMonitoringDataAction(TestDAOFactory.getTestInstance(), Long.parseLong("8000000009"), 2);
		try {
			RemoteMonitoringDataBean b = new RemoteMonitoringDataBean();
			b.setGlucoseLevel(80);
			b.setSystolicBloodPressure(80);
			b.setDiastolicBloodPressure(80);
			actionUAP.addRemoteMonitoringData(b);
		} catch(FormValidationException e) {
			fail();
		}
	}

	/**
	 * testAddRemoteMonitoringDataBloodPressureOnlyUAP
	 * @throws Exception
	 */
	public void testAddRemoteMonitoringDataBloodPressureOnlyUAP() throws Exception {
		gen.uap1();
		gen.remoteMonitoringUAP();
		AddRemoteMonitoringDataAction actionUAP = new AddRemoteMonitoringDataAction(TestDAOFactory.getTestInstance(), Long.parseLong("8000000009"), 2);
		try {
			RemoteMonitoringDataBean b = new RemoteMonitoringDataBean();
			b.setSystolicBloodPressure(100);
			b.setDiastolicBloodPressure(80);
			actionUAP.addRemoteMonitoringData(b);
		} catch(FormValidationException e) {
			fail();
		}
	}

	/**
	 * testRepresentativeReportStatus
	 * @throws Exception
	 */
	public void testRepresentativeReportStatus() throws Exception {
		action = new AddRemoteMonitoringDataAction(TestDAOFactory.getTestInstance(), 2, 1);
		try {
			RemoteMonitoringDataBean b = new RemoteMonitoringDataBean();
			b.setPedometerReading(100);
			action.addRemoteMonitoringData(b);
		} catch(ITrustException e) {
			fail();
		}
	}

	@Override
	protected void setUp() throws Exception {
		gen = new TestDataGenerator();
		gen.clearAllTables();
		gen.hcp0();
		gen.patient1();
		gen.patient2();
		action = new AddRemoteMonitoringDataAction(TestDAOFactory.getTestInstance(), 1, 1);
	}

	/**
	 * testAddRemoteMonitoringDataGlucoseOnlyUAP
	 * @throws Exception
	 */
	public void testAddRemoteMonitoringDataGlucoseOnlyUAP() throws Exception {
		gen.uap1();
		gen.remoteMonitoringUAP();
		AddRemoteMonitoringDataAction actionUAP = new AddRemoteMonitoringDataAction(TestDAOFactory.getTestInstance(), Long.parseLong("8000000009"), 2);
		try {
			RemoteMonitoringDataBean b = new RemoteMonitoringDataBean();
			b.setGlucoseLevel(80);
			actionUAP.addRemoteMonitoringData(b);
		} catch(FormValidationException e) {
			fail();
		}
	}

	public void testCalculateAgeInMonthsAtOfficeVisit() throws Exception{
		OfficeVisitDAO ovDAO = factory.getOfficeVisitDAO();
		OfficeVisitBean ovBean = new OfficeVisitBean(454);
		ovBean.setPatientID(101L);
		ovBean.setERIncident(false);
		ovBean.setHcpID(9000000000L);
		ovBean.setHospitalID("1");
		ovBean.setNotes("");
		ovBean.setVisitDateStr("09/30/2013");
		long ovID = ovDAO.add(ovBean);
		
		action = new ViewHealthRecordsHistoryAction(factory, "101", 101L);
		
		assertEquals(4, action.calculateAgeInMonthsAtOfficeVisit(ovID));
	}

	public void testGetAllPatientHealthRecords() throws Exception{
		OfficeVisitDAO ovDAO = factory.getOfficeVisitDAO();		
		OfficeVisitBean ovBean = new OfficeVisitBean(453);
		ovBean.setPatientID(101L);
		ovBean.setERIncident(false);
		ovBean.setHcpID(9000000000L);
		ovBean.setHospitalID("1");
		ovBean.setNotes("");
		ovBean.setVisitDateStr("09/30/2013");
		long ovID = ovDAO.add(ovBean);
		
		HealthRecordsDAO hrDAO = factory.getHealthRecordsDAO();
		HealthRecord hr = new HealthRecord();
		hr.setPatientID(101L);
		hr.setHeight(20.1);
		hr.setWeight(22.3);
		hr.setHeadCircumference(36.2);
		hr.setHouseholdSmokingStatus(1);
		hr.setOfficeVisitID(ovID);
		hr.setOfficeVisitDateStr("10/01/2013");
		hrDAO.add(hr);
		
		action = new ViewHealthRecordsHistoryAction(factory, "101", 101L);
		List<HealthRecord> testHR = action.getAllPatientHealthRecords();
		assertEquals(hr.getPatientID(), testHR.get(0).getPatientID());
		assertEquals(hr.getHeight(), testHR.get(0).getHeight());
		assertEquals(hr.getWeight(), testHR.get(0).getWeight());
		assertEquals(hr.getHeadCircumference(), testHR.get(0).getHeadCircumference());
		assertEquals(hr.getOfficeVisitID(), testHR.get(0).getOfficeVisitID());
		assertEquals(hr.getVisitDateStr(), testHR.get(0).getVisitDateStr());
		
	}
}
