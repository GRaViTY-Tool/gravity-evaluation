package edu.ncsu.csc.itrust.beans;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

import org.junit.Test;

import edu.ncsu.csc.itrust.action.ViewSleepEntryAction;
import edu.ncsu.csc.itrust.enums.SleepType;
import edu.ncsu.csc.itrust.exception.FormValidationException;
import edu.ncsu.csc.itrust.exception.ITrustException;
import edu.ncsu.csc.itrust.unit.datagenerators.TestDataGenerator;

/**
 * SleepEntryBean.java Version 1 4/6/2015 Copyright notice: none Contains all
 * of the information for an entry into the Sleep Diary.
 * 
 */
public class SleepEntryBean extends EntryBean {

	/**
	 * Unique Primary key so entries can be edited and deleted
	 */
	private long entryID;

	/**
	 * The Date this sleep was performed
	 */
	private String strDate = new SimpleDateFormat("MM/dd/yyyy")
			.format(new Date());

	/**
	 * Was the sleep nightly or a nap?
	 */
	private SleepType sleepType;

	/**
	 * How many hours were spent exercising?
	 */
	private double hoursSlept;

	/**
	 * The MID of the user this sleep entry belongs to
	 */
	private long patientID;

	/**
	 * EntryID of the label belonging to this entry
	 */
	private long labelID;
	
	/**
	 * Returns the id of this entry so it can be edited/deleted.
	 * 
	 * @return unique id of the sleep entry
	 */
	public long getEntryID() {
		return entryID;
	}

	/**
	 * Sets the id of this entry
	 * 
	 * @param id
	 *            the unique id of a sleep entry
	 */
	public void setEntryID(long id) {
		entryID = id;
	}

	/**
	 * Returns a string representation of when the sleep was performed
	 * 
	 * @return string representation of the date on which the sleep was
	 *         performed
	 */
	public String getStrDate() {
		return strDate;
	}

	/**
	 * Parses the strDate to produce a date in the format MM/dd/yyyy
	 * 
	 * @return the date on which the sleep was performed
	 */
	public Date getDate() {
		try {
			return new SimpleDateFormat("MM/dd/yyyy").parse(strDate);
		} catch (ParseException e) {

			return null;
		}
	}

	/**
	 * Sets the date as a string
	 * 
	 * @param strDate
	 *            when the sleep was performed
	 */
	public void setStrDate(String strDate) {
		this.strDate = strDate;
	}

	/**
	 * Which type of sleep was performed?
	 * 
	 * @return the type of sleep
	 */
	public SleepType getSleepType() {
		return sleepType;
	}

	/**
	 * Sets the sleep type
	 * 
	 * @param sleepType
	 *            what type of sleep was it
	 */
	public void setSleepType(String sleepType) {
		this.sleepType = SleepType.parse(sleepType);
	}

	/**
	 * @return the hoursSlept
	 */
	public double getHoursSlept() {
		return hoursSlept;
	}

	/**
	 * @param hoursSlept
	 *            the hoursSlept to set
	 */
	public void setHoursSlept(double hoursSlept) {
		this.hoursSlept = hoursSlept;
	}

	/**
	 * The patient that performed this sleep
	 * 
	 * @return patient ID that performed this sleep
	 */
	public long getPatientID() {
		return patientID;
	}

	/**
	 * Patient that performed this sleep
	 * 
	 * @param patientID
	 *            patient id of who performed this sleep
	 */
	public void setPatientID(long patientID) {
		this.patientID = patientID;
	}
	
	/**
	 * Label of this meal
	 * @return label of this meal
	 */
	public long getLabelID() {
		return labelID;
	}
	
	/**
	 * Label of this meal
	 * @param label of this meal
	 */
	public void setLabelID(long labelID) {
		this.labelID = labelID;
	}

	@Override
	protected void setUp() throws Exception {
		gen = new TestDataGenerator();
		gen.clearAllTables();
		gen.standardData();
		sleepBean = new SleepEntryBean();
		sleepBean.setStrDate("12/12/2012");
		sleepBean.setSleepType("Nap");
		sleepBean.setHoursSlept(1);
		sleepBean.setPatientID(1);
	}

	/**
	 * Testing that we can get the diary when we are searching for range of dates
	 */
	@Test
	public void testViewSleepDiaryDateRange() {
		action = new ViewSleepEntryAction(factory, 1);
		try {
			List<SleepEntryBean> sleepDiary = 
					action.getBoundedDiary("12/12/2012", "12/12/2012", 1);
			assertEquals(1, sleepDiary.size());
			SleepEntryBean entry1 = sleepDiary.get(0);
			//now that we know we have 1 of them, make sure they are the 
			//right ones
			assertEquals("12/12/2012", entry1.getStrDate().toString());
			assertEquals("Nightly", entry1.getSleepType().toString());
			assertEquals(2.0, entry1.getHoursSlept(), .001);
			
			
			//now check the totals
			List<SleepEntryBean> totals = 
					action.getBoundedDiaryTotals("12/12/2012", "12/12/2012", 1);
			assertEquals(1, totals.size());
			SleepEntryBean total = totals.get(0);
			assertEquals(2.0, total.getHoursSlept(), .001);
		} catch (ITrustException e) {
			fail(e.getMessage());
		} catch (FormValidationException d) {
			fail("Do not want an exception");
		}
	}

	/**
	 * Test that a patient can view their sleep diary.
	 */
	@Test
	public void testViewingSleepDiaryAsPatient() {
		action = new ViewSleepEntryAction(factory, 1);
		try {
			List<SleepEntryBean> sleepDiary = action.getDiary(1);
			assertEquals(2, sleepDiary.size());
			SleepEntryBean entry1 = sleepDiary.get(0);
			SleepEntryBean entry2 = sleepDiary.get(1);
			//now that we know we have 2 of them, 
			//make sure they are the right ones
			assertEquals("12/14/2012", entry1.getStrDate().toString());
			assertEquals("Nap", entry1.getSleepType().name());
			assertEquals(1.0, entry1.getHoursSlept());
			assertEquals(1, entry1.getPatientID());
			
			assertEquals("12/12/2012", entry2.getStrDate().toString());
			assertEquals("Nightly", entry2.getSleepType().name());
			assertEquals(2.0, entry2.getHoursSlept());
			assertEquals(1, entry1.getPatientID());
			
			//now check the totals
			List<SleepEntryBean> totals = action.getDiaryTotals(1);
			assertEquals(2, totals.size());
			SleepEntryBean total = totals.get(0);
			assertEquals(1.0, total.getHoursSlept(), .001);
			SleepEntryBean total2 = totals.get(1);
			assertEquals(2.0, total2.getHoursSlept(), .001);
		} catch (ITrustException e) {
			fail(e.getMessage());
		}
	}
}