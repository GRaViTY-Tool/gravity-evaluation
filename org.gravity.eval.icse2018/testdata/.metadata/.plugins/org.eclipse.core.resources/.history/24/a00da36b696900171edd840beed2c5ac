package edu.ncsu.csc.itrust.unit.action;

import java.sql.Timestamp;
import java.util.Calendar;

import edu.ncsu.csc.itrust.action.ViewRecordsReleaseAction;
import edu.ncsu.csc.itrust.beans.RecordsReleaseBean;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.dao.mysql.RecordsReleaseDAO;
import edu.ncsu.csc.itrust.exception.DBException;
import edu.ncsu.csc.itrust.exception.ITrustException;
import edu.ncsu.csc.itrust.unit.datagenerators.TestDataGenerator;
import edu.ncsu.csc.itrust.unit.testutils.EvilDAOFactory;
import edu.ncsu.csc.itrust.unit.testutils.TestDAOFactory;
import junit.framework.TestCase;

public class ViewRecordsReleaseActionTest extends TestCase {
	
	private DAOFactory factory = TestDAOFactory.getTestInstance();
	private DAOFactory evilFactory = EvilDAOFactory.getEvilInstance();
	private TestDataGenerator gen;
	private ViewRecordsReleaseAction action;
	
	@Override
	protected void setUp() throws Exception {
		gen = new TestDataGenerator();
		gen.clearAllTables();
		gen.standardData();
		action = new ViewRecordsReleaseAction(factory, 9000000000L);
	}
	
	public void testDenyRequest() {
		//Add a RecordsReleaseBean
		RecordsReleaseBean release = new RecordsReleaseBean();
		release.setPid(102L);
		release.setDateRequested(new Timestamp(Calendar.getInstance().getTimeInMillis()));
		release.setDocEmail("test@gmail.com");
		release.setDocFirstName("Doctor");
		release.setDocLastName("Super");
		release.setDocPhone("111-111-1111");
		release.setRecHospitalAddress("500 Address Lane");
		release.setRecHospitalName("Worst Hospital");
		release.setReleaseHospitalID("1");
		release.setStatus(0);
		release.setJustification("Who needs a justification?");
		RecordsReleaseDAO rrDAO = new RecordsReleaseDAO(factory);
		try {
			rrDAO.addRecordsRelease(release);
			//Get a records release bean for patient 102
			release = rrDAO.getAllRecordsReleasesByPid(102L).get(0);
		} catch (DBException e) {
			//There should be no DBException
			fail();
		}
		//Get the request id
		long requestID = release.getReleaseID();
		
		//Deny the records release
		assertTrue(action.denyRequest(release));
		//Make sure that the records release status is properly updated
		try {
			release = rrDAO.getRecordsReleaseByID(requestID);
		} catch (DBException e) {
			//There should be no DBException
			fail();
		}
		assertEquals(2, release.getStatus());
		
		//Attempt to deny a request that is not in pending status
		assertFalse(action.denyRequest(release));
	}
	
	public void testGetDoctorName() throws ITrustException {
		//Get Kelly Doctor's name
		assertEquals("Kelly Doctor", action.getDoctorName(9000000000L));
		//Get Shelly Vang's name
		assertEquals("Shelly Vang", action.getDoctorName(8000000011L));
	}
		
}
