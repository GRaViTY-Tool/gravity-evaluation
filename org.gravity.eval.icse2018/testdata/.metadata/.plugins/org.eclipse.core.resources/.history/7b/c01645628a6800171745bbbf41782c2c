package edu.ncsu.csc.itrust.unit.testutils;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.fail;

import java.io.BufferedReader;
import java.io.FileReader;
import java.sql.Connection;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;
import org.apache.commons.dbcp.BasicDataSource;
import org.junit.Test;
import org.w3c.dom.Document;
import org.xml.sax.InputSource;

import edu.ncsu.csc.itrust.action.AddOphthalmologyOVAction;
import edu.ncsu.csc.itrust.action.AddOphthalmologyScheduleOVAction;
import edu.ncsu.csc.itrust.action.AddOphthalmologySurgeryAction;
import edu.ncsu.csc.itrust.action.EditApptAction;
import edu.ncsu.csc.itrust.action.EditOphthalmologyOVAction;
import edu.ncsu.csc.itrust.action.EditOphthalmologyScheduleOVAction;
import edu.ncsu.csc.itrust.action.EditOphthalmologySurgeryAction;
import edu.ncsu.csc.itrust.action.ViewMyApptsAction;
import edu.ncsu.csc.itrust.action.ViewMyMessagesAction;
import edu.ncsu.csc.itrust.action.ViewOphthalmologyScheduleOVAction;
import edu.ncsu.csc.itrust.action.ViewOphthalmologySurgeryAction;
import edu.ncsu.csc.itrust.beans.OphthalmologyOVRecordBean;
import edu.ncsu.csc.itrust.beans.OphthalmologyScheduleOVRecordBean;
import edu.ncsu.csc.itrust.beans.OphthalmologySurgeryRecordBean;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.dao.IConnectionDriver;
import edu.ncsu.csc.itrust.exception.FormValidationException;
import edu.ncsu.csc.itrust.exception.ITrustException;
import edu.ncsu.csc.itrust.unit.datagenerators.TestDataGenerator;

/**
 * This class pulls the JDBC driver information from Tomcat's context.xml file in
 * WebRoot/META-INF/context.xml. This is done only for convenience - so that you only have to pull your JDBC
 * info from one place (context.xml)<br />
 * <br />
 * The tangled mess you see here is SAX, the XML-parser and XPath, an XML querying language. Note that this
 * class is only ever constructed once since DAOFactory only constructs up to 2 instances of itself.<br />
 * <br />
 * Also, you'll notice that we're using a "BasicDataSource" to obtain connections instead of the usual
 * DriverManager. That's because we're using Tomcat's built-in database pooling mechanism. It's purely for
 * performance in this case.
 */
public class TestDAOFactory extends DAOFactory implements IConnectionDriver {

	private static DAOFactory testInstance;

	public static DAOFactory getTestInstance() {
		if (testInstance == null)
			testInstance = new TestDAOFactory();
		return testInstance;
	}

	private BasicDataSource dataSource;

	private TestDAOFactory() {
		try {
			Document document = parseXML(new BufferedReader(new FileReader("WebRoot/META-INF/context.xml")));
			dataSource = new BasicDataSource();
			dataSource.setDriverClassName(getAttribute(document, "@driverClassName"));
			dataSource.setUsername(getAttribute(document, "@username"));
			dataSource.setPassword(getAttribute(document, "@password"));
			dataSource.setUrl(getAttribute(document, "@url"));
			dataSource.setMaxActive(3); // only allow three connections open at a time
			dataSource.setMaxWait(250); // wait 250ms until throwing an exception
			dataSource.setPoolPreparedStatements(true);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	private String getAttribute(Document document, String attribute) throws XPathExpressionException {
		return (String) XPathFactory.newInstance().newXPath().compile("/Context/Resource/" + attribute)
				.evaluate(document.getDocumentElement(), XPathConstants.STRING);
	}

	private Document parseXML(BufferedReader reader) throws Exception {
		DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
		factory.setValidating(false);
		DocumentBuilder builder = factory.newDocumentBuilder();
		return builder.parse(new InputSource(reader));
	}

	@Override
	public Connection getConnection() throws SQLException {
		return dataSource.getConnection();
	}

	@Override
	protected void setUp() throws Exception {
		super.setUp();
		
		TestDataGenerator gen = new TestDataGenerator();
		gen.clearAllTables();
		gen.standardData();
	
		this.factory = TestDAOFactory.getTestInstance();
		this.evilFactory = EvilDAOFactory.getEvilInstance();
		this.action = new ViewMyMessagesAction(this.factory, this.mId);
		this.action2 = new ViewMyMessagesAction(this.factory, this.hcpId);
		this.evilAction = new ViewMyMessagesAction(this.evilFactory, this.mId);
	}

	@Override
	protected void setUp() throws Exception {
		TestDataGenerator gen = new TestDataGenerator();
		gen.clearAllTables();
		gen.hcp0();
		gen.patient42();
		gen.appointment();
		gen.appointmentType();
		gen.uc22();
		
		this.factory = TestDAOFactory.getTestInstance();
		this.evilFactory = EvilDAOFactory.getEvilInstance();
		this.evilAction = new EditApptAction(this.evilFactory, this.hcpId);
		this.editAction = new EditApptAction(this.factory, this.hcpId);
		this.viewAction = new ViewMyApptsAction(this.factory, this.hcpId);
	}

	@Test
	public void testErrors() throws FormValidationException{
		DAOFactory prodDAO = TestDAOFactory.getTestInstance();
		AddOphthalmologyScheduleOVAction addAction = new AddOphthalmologyScheduleOVAction(prodDAO, 401L);
		EditOphthalmologyScheduleOVAction editAction = new EditOphthalmologyScheduleOVAction(prodDAO, 401L);
		
		OphthalmologyScheduleOVRecordBean nullBean = null;
		
		try{
			addAction.addOphthalmologyOV(nullBean);
			fail();
		}catch(ITrustException e){
			assertNull(nullBean);
		}
		
		try{
			editAction.editOphthalmologyScheduleOV(1, nullBean);
			fail();
		}catch(ITrustException e){
			assertNull(nullBean);
		}
	}

	@Test
	public void testAddOphthalmologyOV() throws FormValidationException, ITrustException{
		DAOFactory prodDAO = TestDAOFactory.getTestInstance();
		
		AddOphthalmologyScheduleOVAction addAction = new AddOphthalmologyScheduleOVAction(prodDAO, LOGGED_IN_MID);
		
		OphthalmologyScheduleOVRecordBean bean1 = new OphthalmologyScheduleOVRecordBean();
		bean1.setComment("Comment");
		bean1.setDoctormid(101);
		bean1.setPatientmid(102);
		bean1.setPending(true);
		bean1.setDocFirstName("bill");
		bean1.setDocLastName("phil");
		SimpleDateFormat frmt = new SimpleDateFormat("MM/dd/yyyy hh:mm a");
		Date d;
		try {
			d = frmt.parse("20/20/1994 10:22 PM");
			bean1.setDate(new Timestamp(d.getTime()));
		} catch (ParseException e1) {
			//Won't happen
		}
		
		OphthalmologyScheduleOVRecordBean bean2 = new OphthalmologyScheduleOVRecordBean();
		bean2.setComment("Comment");
		bean2.setDoctormid(101);
		bean2.setPatientmid(102);
		bean2.setPending(true);
		bean2.setDocFirstName("bill");
		bean2.setDocLastName("phil");
		frmt = new SimpleDateFormat("MM/dd/yyyy hh:mm a");
		try {
			d = frmt.parse("20/20/1994 10:23 PM");
			bean2.setDate(new Timestamp(d.getTime()));
		} catch (ParseException e1) {
			//Won't happen
		}
		
		OphthalmologyScheduleOVRecordBean bean3 = new OphthalmologyScheduleOVRecordBean();
		bean3.setComment("Comment");
		bean3.setDoctormid(101);
		bean3.setPatientmid(102);
		bean3.setPending(true);
		bean3.setDocFirstName("bill");
		bean3.setDocLastName("phil");
		frmt = new SimpleDateFormat("MM/dd/yyyy hh:mm a");
		try {
			d = frmt.parse("20/20/1994 10:24 PM");
			bean3.setDate(new Timestamp(d.getTime()));
		} catch (ParseException e1) {
			//Won't happen
		}
		
		OphthalmologyScheduleOVRecordBean bean4 = new OphthalmologyScheduleOVRecordBean();
		bean4.setComment("Comment");
		bean4.setDoctormid(101);
		bean4.setPatientmid(102);
		bean4.setPending(true);
		bean4.setDocFirstName("bill");
		bean4.setDocLastName("phil");
		frmt = new SimpleDateFormat("MM/dd/yyyy hh:mm a");
		try {
			d = frmt.parse("20/20/1994 10:25 PM");
			bean4.setDate(new Timestamp(d.getTime()));
		} catch (ParseException e1) {
			//Won't happen
		}
		
		OphthalmologyScheduleOVRecordBean bean5 = new OphthalmologyScheduleOVRecordBean();
		bean5.setComment("Comment");
		bean5.setDoctormid(101);
		bean5.setPatientmid(102);
		bean5.setPending(true);
		bean5.setDocFirstName("bill");
		bean5.setDocLastName("phil");
		frmt = new SimpleDateFormat("MM/dd/yyyy hh:mm a");
		try {
			d = frmt.parse("20/20/1994 10:26 PM");
			bean5.setDate(new Timestamp(d.getTime()));
		} catch (ParseException e1) {
			//Won't happen
		}
		
		
		
		//Add the beans
		addAction.addOphthalmologyOV(bean1);
		addAction.addOphthalmologyOV(bean2);
		addAction.addOphthalmologyOV(bean3);
		addAction.addOphthalmologyOV(bean4);
		addAction.addOphthalmologyOV(bean5);
		
		//Now test the view
		ViewOphthalmologyScheduleOVAction viewAction = new ViewOphthalmologyScheduleOVAction(prodDAO, LOGGED_IN_MID);
		
		OphthalmologyScheduleOVRecordBean retBean = viewAction.getOphthalmologyScheduleOVForHCP(1L);
		assertEquals(bean1, retBean);
		
		List<OphthalmologyScheduleOVRecordBean> beans = viewAction.getOphthalmologyScheduleOVByPATIENTMID(102L);
		assertEquals(beans.get(0), bean5);
		assertEquals(beans.get(1), bean4);
		assertEquals(beans.get(2), bean3);
		assertEquals(beans.get(3), bean2);
		
		EditOphthalmologyScheduleOVAction editAction = new EditOphthalmologyScheduleOVAction(prodDAO, LOGGED_IN_MID);
		editAction.editOphthalmologyScheduleOV(2L, bean3);
		bean3.setOid(2L);
		assertEquals(viewAction.getOphthalmologyScheduleOVForPatient(2L), bean3);
		
		//Now test the view for a Patient viewing their own records
		ViewOphthalmologyScheduleOVAction patientViewAction = new ViewOphthalmologyScheduleOVAction(prodDAO, PATIENT_MID);
		retBean = patientViewAction.getOphthalmologyScheduleOVForPatient(1L);
		assertEquals(bean1, retBean);
		
		//Now test the view for a Patient viewing a Dependent's records
		retBean = patientViewAction.getOphthalmologyScheduleOVForPatient(5L);
		assertEquals(bean5, retBean);
	}

	@Test
	public void testAddOphthalmologySurgery() throws FormValidationException, ITrustException{
		DAOFactory prodDAO = TestDAOFactory.getTestInstance();
		
		AddOphthalmologySurgeryAction addAction = new AddOphthalmologySurgeryAction(prodDAO, LOGGED_IN_MID);
		
		//Create a valid bean
		OphthalmologySurgeryRecordBean bean1 = new OphthalmologySurgeryRecordBean();
		bean1.setMid(PATIENT_MID);
		bean1.setVisitDate("01/22/2015");
		bean1.setLastName("Bridges");
		bean1.setFirstName("Lamar");
		bean1.setVaNumOD(27);
		bean1.setVaDenOD(12);
		bean1.setVaNumOS(27);
		bean1.setVaDenOS(12);
		bean1.setSphereOD(+9.25);
		bean1.setSphereOS(-8.25);
		bean1.setCylinderOD(1.0);
		bean1.setCylinderOS(1.25);
		bean1.setAxisOD(14);
		bean1.setAxisOS(23);
		bean1.setAddOD(2.5);
		bean1.setAddOS(0.75);
		bean1.setSurgery("Cataract Surgery");
		bean1.setSurgeryNotes("Surgery successful.");
		
		//Create another valid bean
		OphthalmologySurgeryRecordBean bean2 = new OphthalmologySurgeryRecordBean();
		bean2.setMid(PATIENT_MID);
		bean2.setVisitDate("01/23/2015");
		bean2.setLastName("Bridges");
		bean2.setFirstName("Lamar");
		bean2.setVaNumOD(27);
		bean2.setVaDenOD(12);
		bean2.setVaNumOS(27);
		bean2.setVaDenOS(12);
		bean2.setSphereOD(+9.25);
		bean2.setSphereOS(-8.25);
		bean2.setAddOD(2.50);
		bean2.setAddOS(0.75);
		bean2.setSurgery("Laser Surgery");
		bean2.setSurgeryNotes("Surgery was boring.");
		
		//Create another valid bean
		OphthalmologySurgeryRecordBean bean3 = new OphthalmologySurgeryRecordBean();
		bean3.setMid(PATIENT_MID);
		bean3.setVisitDate("01/24/2015");
		bean3.setLastName("Tran");
		bean3.setFirstName("Brooke");
		bean3.setVaNumOD(27);
		bean3.setVaDenOD(12);
		bean3.setVaNumOS(27);
		bean3.setVaDenOS(12);
		bean3.setSphereOD(+9.25);
		bean3.setSphereOS(-8.25);
		bean3.setCylinderOS(1.25);
		bean3.setAxisOS(23);
		bean3.setAddOD(2.0);
		bean3.setAddOS(0.75);
		bean3.setSurgery("Refractive Surgery");
		bean3.setSurgeryNotes("Yet another surgery.");
		
		//Create another valid bean
		OphthalmologySurgeryRecordBean bean4 = new OphthalmologySurgeryRecordBean();
		bean4.setMid(PATIENT_MID);
		bean4.setVisitDate("01/26/2015");
		bean4.setLastName("Tran");
		bean4.setFirstName("Brooke");
		bean4.setVaNumOD(27);
		bean4.setVaDenOD(12);
		bean4.setVaNumOS(27);
		bean4.setVaDenOS(12);
		bean4.setSphereOD(+9.25);
		bean4.setSphereOS(-8.25);
		bean4.setCylinderOD(1.25);
		bean4.setAxisOD(23);
		bean4.setAddOD(2.75);
		bean4.setAddOS(0.75);
		// Surgery and notes aren't required
		
		//Create another valid bean
		OphthalmologySurgeryRecordBean bean5 = new OphthalmologySurgeryRecordBean();
		bean5.setMid(DEPENDENT_MID);
		bean5.setVisitDate("01/26/2015");
		bean5.setLastName("Tran");
		bean5.setFirstName("Brooke");
		bean5.setVaNumOD(27);
		bean5.setVaDenOD(12);
		bean5.setVaNumOS(27);
		bean5.setVaDenOS(12);
		bean5.setSphereOD(+9.25);
		bean5.setSphereOS(-8.25);
		bean5.setCylinderOD(1.25);
		bean5.setAxisOD(23);
		bean5.setAddOD(2.75);
		bean5.setAddOS(0.75);
		bean5.setSurgeryNotes("Surgery rescheduled");
		
		//Add the beans
		addAction.addOphthalmologySurgery(bean1);
		addAction.addOphthalmologySurgery(bean2);
		addAction.addOphthalmologySurgery(bean3);
		addAction.addOphthalmologySurgery(bean4);
		addAction.addOphthalmologySurgery(bean5);
		
		//Now test the view
		ViewOphthalmologySurgeryAction viewAction = new ViewOphthalmologySurgeryAction(prodDAO, LOGGED_IN_MID);
		
		OphthalmologySurgeryRecordBean retBean = viewAction.getOphthalmologySurgeryForHCP(1L);
		assertEquals(bean1, retBean);
		
		List<OphthalmologySurgeryRecordBean> beans = viewAction.getOphthalmologySurgeryByMID(PATIENT_MID);
		assertEquals(beans.get(0), bean4);
		assertEquals(beans.get(1), bean3);
		assertEquals(beans.get(2), bean2);
		assertEquals(beans.get(3), bean1);
		
		EditOphthalmologySurgeryAction editAction = new EditOphthalmologySurgeryAction(prodDAO, LOGGED_IN_MID);
		editAction.editOphthalmologySurgery(2L, bean3);
		bean3.setOid(2L);
		assertEquals(viewAction.getOphthalmologySurgeryForHCP(2L), bean3);
		
		// Patients don't have to be able to view their surgical records, per documentation
	}

	public void testErrors() throws FormValidationException{
		DAOFactory prodDAO = TestDAOFactory.getTestInstance();
		AddOphthalmologySurgeryAction addAction = new AddOphthalmologySurgeryAction(prodDAO, 401L);
		EditOphthalmologySurgeryAction editAction = new EditOphthalmologySurgeryAction(prodDAO, 401L);
		
		OphthalmologySurgeryRecordBean nullBean = null;
		
		try{
			addAction.addOphthalmologySurgery(nullBean);
			fail();
		}catch(ITrustException e){
			assertNull(nullBean);
		}
		
		try{
			editAction.editOphthalmologySurgery(1, nullBean);
			fail();
		}catch(ITrustException e){
			assertNull(nullBean);
		}
	}

	@Test
	public void testErrors() throws FormValidationException{
		DAOFactory prodDAO = TestDAOFactory.getTestInstance();
		AddOphthalmologyOVAction addAction = new AddOphthalmologyOVAction(prodDAO, 401L);
		EditOphthalmologyOVAction editAction = new EditOphthalmologyOVAction(prodDAO, 401L);
		
		OphthalmologyOVRecordBean nullBean = null;
		
		try{
			addAction.addOphthalmologyOV(nullBean);
			fail();
		}catch(ITrustException e){
			assertNull(nullBean);
		}
		
		try{
			editAction.editOphthalmologyOV(1, nullBean);
			fail();
		}catch(ITrustException e){
			assertNull(nullBean);
		}
	}
}
